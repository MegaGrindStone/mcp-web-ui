{{template "base.html" .}}

{{define "content"}}
<div class="container-fluid vh-100 py-3">
    <div class="row h-100">
        <div class="col-3 h-100">
            <!-- List Chats -->
            <div class="card h-50 mb-2">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Chats</h5>
                        <a href="/" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus"></i> New Chat
                        </a>
                    </div>
                </div>
                <div class="list-group list-group-flush overflow-auto"
                    hx-ext="sse"
                    sse-connect="/sse/chats"
                    sse-close="closeChat"
                    sse-swap="chats"
                    hx-swap="innerHTML">
                    {{range .Chats}}
                      {{template "chat_title" .}}
                    {{end}}
                </div>
            </div>
            <!-- MCP Container -->
            <div class="card h-50 mb-2">
                <div class="card-header">
                    <h5 class="card-title mb-0">MCP</h5>
                </div>
                <div class="card-body p-0">
                    <div class="accordion" id="mcpAccordion">
                        <!-- List Servers -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Servers
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#mcpAccordion">
                                <div class="accordion-body">
                                    <div class="list-group list-group-flush">
                                        {{range .Servers}}
                                        <div class="list-group-item" role="button" style="cursor: pointer" 
                                            onclick="showServerModal('{{.Name}}')">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>{{.Name}}</span>
                                                <span class="badge bg-secondary">{{.Version}}</span>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- List Tools -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseOne">
                                    Tools
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#mcpAccordion">
                                <div class="accordion-body">
                                    <div class="list-group list-group-flush">
                                        {{range .Tools}}
                                        <div class="list-group-item" role="button" style="cursor: pointer">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>{{.Name}}</span>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- List Resources -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseTwo">
                                    Resources
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#mcpAccordion">
                                <div class="accordion-body">
                                    <div class="list-group list-group-flush">
                                        {{range $index, $resource := .Resources}}
                                        <div class="list-group-item" role="button" style="cursor: pointer" 
                                            onclick="showResourceModal({{$index}})">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>{{$resource.Name}}</span>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- List Prompts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseThree">
                                    Prompts
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#mcpAccordion">
                                <div class="accordion-body">
                                    <div class="list-group list-group-flush">
                                        {{range $index, $prompt := .Prompts}}
                                        <div class="list-group-item" role="button" style="cursor: pointer" 
                                            onclick="showPromptModal({{$index}})">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>{{$prompt.Name}}</span>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chat Messages Container -->
        <div class="col-9 h-100" id="chat-container">
            {{if .CurrentChatID}}
              {{template "chatbox" .}}
            {{else}}
              {{template "welcome" .}}
              <script>
                // Only redirect if we have a chat_id in the URL but no valid chat was found
                const urlParams = new URLSearchParams(window.location.search);
                const hasChatIdParam = urlParams.has('chat_id');
                
                if (hasChatIdParam) {
                  window.location.href = '/';
                }
              </script>
            {{end}}
        </div>
    </div>
</div>

<div class="modal fade" id="serverModal" tabindex="-1" aria-labelledby="serverModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serverModalLabel">Server Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="serverModalText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptModalLabel">Prompt Arguments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="promptDescription" class="mb-3"></p>
                <form id="promptForm">
                    <div id="promptArguments">
                        <!-- Arguments will be dynamically added here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="usePromptBtn">Use Prompt</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resourceModal" tabindex="-1" aria-labelledby="resourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resourceModalLabel">Resource Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="resourceName"></h6>
                <p id="resourceDescription" class="mb-3"></p>
                <div class="mb-3">
                    <strong>URI:</strong> <span id="resourceUri"></span>
                </div>
                <div class="mb-3">
                    <strong>MIME Type:</strong> <span id="resourceMimeType"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="useResourceBtn">Use Resource</button>
            </div>
        </div>
    </div>
</div>

<script>
function showServerModal(serverName) {
    const modalText = document.getElementById('serverModalText');
    modalText.textContent = `Server: ${serverName}`;
    const modal = new bootstrap.Modal(document.getElementById('serverModal'));
    modal.show();
}

function handleKeyPress(event, formID) {
    if (event.key === 'Enter') {
        if (!event.shiftKey) {
            event.preventDefault();
            htmx.trigger(formID, 'submit');
        }
    }
    // Auto-expand height
    adjustHeight(event.target);
}

function adjustHeight(element) {
    element.style.height = 'auto';
    element.style.height = (element.scrollHeight) + 'px';
}

// Store the prompts data
const promptsList = [{{range $index, $prompt := .Prompts}}
    {
        name: `{{$prompt.Name}}`,
        description: `{{$prompt.Description}}`,
        arguments: [{{range $prompt.Arguments}}
            {
                name: `{{.Name}}`,
                description: `{{.Description}}`,
                required: {{.Required}}
            },{{end}}
        ]
    },{{end}}
];

// Store the resources data
const resourcesList = [{{range $index, $resource := .Resources}}
    {
        uri: `{{$resource.URI}}`,
        name: `{{$resource.Name}}`,
        description: `{{$resource.Description}}`,
        mimeType: `{{$resource.MimeType}}`
    },{{end}}
];

function showPromptModal(promptIndex) {
    const promptData = promptsList[promptIndex];
    if (!promptData) {
        console.error('Prompt not found at index:', promptIndex);
        return;
    }
    
    // Set the modal title and description
    document.getElementById('promptModalLabel').textContent = `Prompt: ${promptData.name}`;
    const descElem = document.getElementById('promptDescription');
    descElem.textContent = promptData.description || '';
    
    // Get the form element where we'll add the inputs
    const argContainer = document.getElementById('promptArguments');
    argContainer.innerHTML = '';
    
    // Create input fields for each argument
    if (promptData.arguments && promptData.arguments.length > 0) {
        promptData.arguments.forEach(arg => {
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            
            const label = document.createElement('label');
            label.htmlFor = `arg-${arg.name}`;
            label.className = 'form-label';
            label.textContent = arg.name;
            if (arg.required) {
                label.textContent += ' *';
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.id = `arg-${arg.name}`;
            input.name = arg.name;
            input.required = arg.required;
            
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            
            if (arg.description) {
                const helpText = document.createElement('div');
                helpText.className = 'form-text';
                helpText.textContent = arg.description;
                formGroup.appendChild(helpText);
            }
            
            argContainer.appendChild(formGroup);
        });
    } else {
        // If there are no arguments, show a message
        const noArgsMsg = document.createElement('p');
        noArgsMsg.textContent = 'This prompt has no arguments.';
        argContainer.appendChild(noArgsMsg);
    }
    
    // Set up the "Use Prompt" button handler
    document.getElementById('usePromptBtn').onclick = function() {
        // Collect prompt data and arguments
        const args = {};
        const promptName = promptData.name;
        
        if (promptData.arguments) {
            promptData.arguments.forEach(arg => {
                const input = document.getElementById(`arg-${arg.name}`);
                if (input) {
                    args[arg.name] = input.value;
                }
            });
        }
        
        // Determine which form to use
        const isWelcomePage = document.getElementById('chat-form-welcome') !== null;
        const formId = isWelcomePage ? 'chat-form-welcome' : 'chat-form-chatbox';
        const form = document.getElementById(formId);

        // Get the textarea and temporarily remove required attribute
        const textarea = form.querySelector('textarea[name="message"]');
        textarea.removeAttribute('required');

        // Clear the message field and set prompt data
        textarea.value = '';
        form.querySelector('input[name="prompt_name"]').value = promptName;
        form.querySelector('input[name="prompt_args"]').value = JSON.stringify(args);
        
        // Set up a one-time event listener for after the request completes
        form.addEventListener('htmx:afterRequest', function afterRequest() {
            // Restore the required attribute and clear prompt fields
            textarea.setAttribute('required', '');
            form.querySelector('input[name="prompt_name"]').value = '';
            form.querySelector('input[name="prompt_args"]').value = '';
            
            // Remove this event listener to prevent it from firing on future requests
            form.removeEventListener('htmx:afterRequest', afterRequest);
        }, { once: true });
        
        // Submit the form
        htmx.trigger(form, 'submit');
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('promptModal')).hide();
    };
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('promptModal')).show();
}

// Track attached resources
let attachedResources = [];

function attachResource(resource) {
    // Add resource to the tracking array if not already present
    if (!attachedResources.some(r => r.uri === resource.uri)) {
        attachedResources.push(resource);
        updateAttachedResourcesDisplay();
    }
}

function removeResource(uri) {
    // Remove the resource from the tracking array
    attachedResources = attachedResources.filter(r => r.uri !== uri);
    updateAttachedResourcesDisplay();
}

function clearAttachedResources() {
    attachedResources = [];
    updateAttachedResourcesDisplay();
}

function updateAttachedResourcesDisplay() {
    // Get the container element
    const container = document.getElementById('attached-resources-container');
    const list = document.getElementById('attached-resources-list');
    
    if (!container || !list) return;
    
    // Show/hide the container based on whether there are resources
    container.style.display = attachedResources.length > 0 ? 'block' : 'none';
    
    // Clear the list
    list.innerHTML = '';
    
    // Add badges for each resource
    attachedResources.forEach(resource => {
        const badge = document.createElement('div');

        // Create display text with name and URI
        let displayText = resource.name || 'Resource';
        if (resource.uri) {
            displayText += ` (${resource.uri})`;
        }

        badge.className = 'badge bg-secondary text-white d-flex align-items-center p-2 me-1 mb-1';
        badge.innerHTML = `
            <span class="me-2 text-truncate" style="max-width: 250px;" title="${displayText}">${displayText}</span>
            <button type="button" class="btn-close btn-close-white btn-close-sm flex-shrink-0" 
                    aria-label="Remove" onclick="removeResource('${resource.uri}')"></button>
        `;
        list.appendChild(badge);
    });
    
    // Update the hidden form input
    const isWelcomePage = document.getElementById('chat-form-welcome') !== null;
    const formId = isWelcomePage ? 'chat-form-welcome' : 'chat-form-chatbox';
    const form = document.getElementById(formId);
    
    if (form) {
        const input = form.querySelector('input[name="attached_resources"]');
        if (input) {
            input.value = JSON.stringify(attachedResources.map(r => r.uri));
        }
    }
}

function showResourceModal(resourceIndex) {
    const resourceData = resourcesList[resourceIndex];
    if (!resourceData) {
        console.error('Resource not found at index:', resourceIndex);
        return;
    }
    
    // Set the modal content
    document.getElementById('resourceName').textContent = resourceData.name || 'Unnamed Resource';
    document.getElementById('resourceDescription').textContent = resourceData.description || 'No description available';
    document.getElementById('resourceUri').textContent = resourceData.uri || '';
    document.getElementById('resourceMimeType').textContent = resourceData.mimeType || 'Unknown';

    // Set up the "Use Resource" button handler
    document.getElementById('useResourceBtn').onclick = function() {
        attachResource(resourceData);
        bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
    };
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('resourceModal')).show();
}

document.addEventListener('DOMContentLoaded', function() {
    // Fix any trailing commas in arrays
    for (let i = 0; i < promptsList.length; i++) {
        if (promptsList[i].arguments && promptsList[i].arguments.length > 0) {
            // Remove any undefined items that may have been created by trailing commas
            promptsList[i].arguments = promptsList[i].arguments.filter(item => item !== undefined);
        }
    }

    // clean up the resources list
    resourcesList = resourcesList.filter(item => item !== undefined);
});
</script>
{{end}}
